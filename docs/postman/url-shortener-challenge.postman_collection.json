{
  "info": {
    "name": "URL Shortener Challenge",
    "_postman_id": "b7f5a26d-3ea9-4f8b-9ab4-12c6e8e8b3f1",
    "description": "End-to-end Postman harness for auth, API key lifecycle, links, stats, negatives, and public endpoints.\n\nExecution order:\n1) Auth/Signup\n2) Auth/Login\n3) API Keys/Rotate (JWT)\n4) Links/Create (Bearer)\n5) Links/Stats (Bearer)\n6) Links/Stats (ApiKey)\n7) Negative tests\n8) Public endpoints\n\nEnvironment values override collection defaults (for example unknown_slug).",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const autoAuth = (pm.environment.get('AUTO_AUTH') || pm.collectionVariables.get('AUTO_AUTH') || 'true') === 'true';",
          "const modeHeader = (pm.request.headers.get('X-Auth-Mode') || 'none').toLowerCase();",
          "",
          "function envGet(key) { return pm.environment.get(key) || pm.collectionVariables.get(key) || ''; }",
          "function setAuthHeader(value) {",
          "  pm.request.headers.upsert({ key: 'Authorization', value });",
          "}",
          "function clearAuthHeader() { pm.request.headers.remove('Authorization'); }",
          "function cleanupInternalHeaders() { pm.request.headers.remove('X-Auth-Mode'); }",
          "",
          "function login(cb) {",
          "  pm.sendRequest({",
          "    url: `${envGet('base_url')}/login`,",
          "    method: 'POST',",
          "    header: { 'Content-Type': 'application/json' },",
          "    body: { mode: 'raw', raw: JSON.stringify({ user: { email: envGet('email'), password: envGet('password') } }) }",
          "  }, function (err, res) {",
          "    if (!err && res && res.code === 200) {",
          "      const json = res.json();",
          "      if (json.token) {",
          "        pm.environment.set('token', json.token);",
          "      } else {",
          "        pm.environment.unset('token');",
          "        console.error('Auto-auth login: response missing token');",
          "      }",
          "    } else {",
          "      pm.environment.unset('token');",
          "      console.error('Auto-auth login failed', err || (res && res.code));",
          "    }",
          "    cb();",
          "  });",
          "}",
          "",
          "function rotate(cb) {",
          "  const token = envGet('token');",
          "  if (!token) return cb();",
          "  pm.sendRequest({",
          "    url: `${envGet('base_url')}/api_keys/rotate`,",
          "    method: 'POST',",
          "    header: { Authorization: `Bearer ${token}` }",
          "  }, function (err, res) {",
          "    if (!err && res && res.code === 200) {",
          "      const json = res.json();",
          "      if (json.api_key) {",
          "        pm.environment.set('api_key', json.api_key);",
          "      } else {",
          "        pm.environment.unset('api_key');",
          "        console.error('Auto-auth rotate: response missing api_key');",
          "      }",
          "      if (json.api_key_last4) pm.environment.set('api_key_last4', json.api_key_last4);",
          "    } else {",
          "      pm.environment.unset('api_key');",
          "      console.error('Auto-auth rotate failed', err || (res && res.code));",
          "    }",
          "    cb();",
          "  });",
          "}",
          "",
          "if (!autoAuth) { clearAuthHeader(); cleanupInternalHeaders(); }",
          "else if (modeHeader === 'none') { clearAuthHeader(); cleanupInternalHeaders(); }",
          "else if (modeHeader === 'bearer') {",
          "  if (!envGet('token')) {",
          "    login(function () {",
          "      setAuthHeader(`Bearer ${envGet('token')}`);",
          "      cleanupInternalHeaders();",
          "    });",
          "  } else {",
          "    setAuthHeader(`Bearer ${envGet('token')}`);",
          "    cleanupInternalHeaders();",
          "  }",
          "}",
          "else if (modeHeader === 'apikey') {",
          "  function finishApiKey() {",
          "    const key = envGet('api_key');",
          "    if (!key) {",
          "      console.error('Auto-auth apikey mode: api_key is empty after rotate/login');",
          "      clearAuthHeader();",
          "      cleanupInternalHeaders();",
          "      return;",
          "    }",
          "    setAuthHeader(`ApiKey ${key}`);",
          "    cleanupInternalHeaders();",
          "  }",
          "  if (!envGet('api_key')) {",
          "    if (!envGet('token')) {",
          "      login(function () { rotate(finishApiKey); });",
          "    } else {",
          "      rotate(finishApiKey);",
          "    }",
          "  } else finishApiKey();",
          "}",
          "else if (modeHeader === 'old_apikey') { setAuthHeader(`ApiKey ${envGet('old_api_key')}`); cleanupInternalHeaders(); }",
          "else if (modeHeader === 'invalid_apikey') { setAuthHeader('ApiKey invalid_key'); cleanupInternalHeaders(); }",
          "else { clearAuthHeader(); cleanupInternalHeaders(); }"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Signup",
          "description": "Creates user, returns token + api_key once.",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"user\": {\n    \"name\": \"{{name}}\",\n    \"email\": \"{{email}}\",\n    \"password\": \"{{password}}\"\n  }\n}"
            },
            "url": "{{base_url}}/signup"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const baseEmail = pm.environment.get('email') || pm.collectionVariables.get('email') || 'postman.local@example.com';",
                  "const parts = baseEmail.split('@');",
                  "const local = parts[0] || 'postman.local';",
                  "const domain = parts[1] || 'example.com';",
                  "pm.environment.set('email', `${local}+${Date.now()}@${domain}`);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 201', function () { pm.response.to.have.status(201); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "pm.test('Signup contract', function () {",
                  "  pm.expect(json).to.have.property('token');",
                  "  pm.expect(json.user.api_key_last4).to.have.length(4);",
                  "});",
                  "pm.environment.set('token', json.token);",
                  "pm.environment.set('api_key', json.user.api_key);",
                  "pm.environment.set('api_key_last4', json.user.api_key_last4);"
                ]
              }
            }
          ]
        },
        {
          "name": "Login",
          "description": "Authenticates existing user, should not expose full api_key.",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"user\": {\n    \"email\": \"{{email}}\",\n    \"password\": \"{{password}}\"\n  }\n}"
            },
            "url": "{{base_url}}/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "pm.test('Login contract', function () {",
                  "  pm.expect(json).to.have.property('token');",
                  "  pm.expect(json.user.api_key).to.be.undefined;",
                  "});",
                  "pm.environment.set('token', json.token);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "API Keys",
      "item": [
        {
          "name": "Rotate (JWT)",
          "description": "Rotate api key with Bearer token.",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "bearer"
              }
            ],
            "url": "{{base_url}}/api_keys/rotate"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "const oldKey = pm.environment.get('api_key');",
                  "if (oldKey) pm.environment.set('old_api_key', oldKey);",
                  "pm.environment.set('api_key', json.api_key);",
                  "pm.environment.set('api_key_last4', json.api_key_last4);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Links",
      "item": [
        {
          "name": "Create (Bearer)",
          "description": "Create short link; supports Runner data long_url override.",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "bearer"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"link\": {\n    \"long_url\": \"{{long_url}}\"\n  }\n}"
            },
            "url": "{{base_url}}/links"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const dataLong = pm.iterationData.get('long_url');",
                  "if (dataLong) pm.environment.set('long_url', dataLong);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 201', function () { pm.response.to.have.status(201); });",
                  "const json = pm.response.json();",
                  "pm.test('Create contract', function () {",
                  "  pm.expect(json.slug).to.be.a('string').and.not.empty;",
                  "  pm.expect(json.short_url).to.be.a('string');",
                  "});",
                  "pm.environment.set('slug', json.slug);"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Invalid URL (422)",
          "description": "Invalid URL should return 422.",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "bearer"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"link\": {\n    \"long_url\": \"not-a-url\"\n  }\n}"
            },
            "url": "{{base_url}}/links"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 422', function () { pm.response.to.have.status(422); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Index (ApiKey)",
          "description": "List links with ApiKey auth.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "apikey"
              }
            ],
            "url": "{{base_url}}/links"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "pm.test('Index contract', function () { pm.expect(json.links).to.be.an('array'); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Stats (Bearer)",
          "description": "Stats with Bearer auth.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "bearer"
              }
            ],
            "url": "{{base_url}}/links/stats"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "pm.test('Stats contract', function () {",
                  "  pm.expect(json.links).to.be.an('array');",
                  "  if (json.links.length > 0) {",
                  "    pm.expect(json.links[0].total_clicks).to.be.a('number');",
                  "    pm.expect(json.links[0].unique_visits).to.be.a('number');",
                  "  }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Stats (ApiKey)",
          "description": "Stats with current ApiKey.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "apikey"
              }
            ],
            "url": "{{base_url}}/links/stats"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });",
                  "pm.test('JSON content-type', function () { pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json'); });",
                  "const json = pm.response.json();",
                  "pm.test('Stats ApiKey contract', function () { pm.expect(json.links).to.be.an('array'); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Stats (Old ApiKey - Should 401)",
          "description": "Old key should be rejected.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "old_apikey"
              }
            ],
            "url": "{{base_url}}/links/stats"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const oldKey = pm.environment.get('old_api_key');",
                  "pm.test('old_api_key exists', function () { pm.expect(oldKey, 'old_api_key missing: run Rotate after having api_key').to.be.ok; });",
                  "pm.test('Status is 401', function () { pm.response.to.have.status(401); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Stats Missing Auth (401)",
          "description": "Missing auth should fail.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              }
            ],
            "url": "{{base_url}}/links/stats"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 401', function () { pm.response.to.have.status(401); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Stats Invalid ApiKey (401)",
          "description": "Invalid key should fail.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "invalid_apikey"
              }
            ],
            "url": "{{base_url}}/links/stats"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 401', function () { pm.response.to.have.status(401); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Public",
      "item": [
        {
          "name": "Top Links",
          "description": "Public top links endpoint.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              }
            ],
            "url": "{{base_url}}/links/top"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Redirect - By Slug",
          "description": "Redirect existing slug.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              }
            ],
            "url": "{{base_url}}/{{slug}}"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const existingSlug = pm.environment.get('slug') || pm.collectionVariables.get('slug') || '';",
                  "if (existingSlug) { return; }",
                  "",
                  "const baseUrl = pm.environment.get('base_url') || pm.collectionVariables.get('base_url');",
                  "const emailBase = pm.environment.get('email') || pm.collectionVariables.get('email');",
                  "const password = pm.environment.get('password') || pm.collectionVariables.get('password');",
                  "const name = pm.environment.get('name') || pm.collectionVariables.get('name') || 'Postman User';",
                  "const longUrl = pm.environment.get('long_url') || pm.collectionVariables.get('long_url') || 'https://example.com/very/long/path';",
                  "",
                  "function setSlugFromCreate(res) {",
                  "  if (!res || res.code !== 201) {",
                  "    console.error('Auto-create link failed for redirect setup', res && res.code, res && res.text && res.text());",
                  "    return;",
                  "  }",
                  "  const json = res.json();",
                  "  if (!json.slug) {",
                  "    console.error('Auto-create link response missing slug', json);",
                  "    return;",
                  "  }",
                  "  pm.environment.set('slug', json.slug);",
                  "}",
                  "",
                  "function createLink(token) {",
                  "  pm.sendRequest({",
                  "    url: `${baseUrl}/links`,",
                  "    method: 'POST',",
                  "    header: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },",
                  "    body: { mode: 'raw', raw: JSON.stringify({ link: { long_url: longUrl } }) }",
                  "  }, function (_err, res) {",
                  "    setSlugFromCreate(res);",
                  "  });",
                  "}",
                  "",
                  "function loginAndCreate() {",
                  "  const loginEmail = pm.environment.get('email') || emailBase;",
                  "  pm.sendRequest({",
                  "    url: `${baseUrl}/login`,",
                  "    method: 'POST',",
                  "    header: { 'Content-Type': 'application/json' },",
                  "    body: { mode: 'raw', raw: JSON.stringify({ user: { email: loginEmail, password } }) }",
                  "  }, function (_err, res) {",
                  "    if (res && res.code === 200) {",
                  "      const json = res.json();",
                  "      if (json.token) {",
                  "        pm.environment.set('token', json.token);",
                  "        createLink(json.token);",
                  "        return;",
                  "      }",
                  "    }",
                  "    signupAndCreate();",
                  "  });",
                  "}",
                  "",
                  "function signupAndCreate() {",
                  "  const parts = String(emailBase || 'postman.local@example.com').split('@');",
                  "  const local = parts[0] || 'postman.local';",
                  "  const domain = parts[1] || 'example.com';",
                  "  const signupEmail = `${local}+${Date.now()}@${domain}`;",
                  "  pm.environment.set('email', signupEmail);",
                  "",
                  "  pm.sendRequest({",
                  "    url: `${baseUrl}/signup`,",
                  "    method: 'POST',",
                  "    header: { 'Content-Type': 'application/json' },",
                  "    body: { mode: 'raw', raw: JSON.stringify({ user: { name, email: signupEmail, password } }) }",
                  "  }, function (_err, res) {",
                  "    if (!res || res.code !== 201) {",
                  "      console.error('Auto-signup failed for redirect setup', res && res.code, res && res.text && res.text());",
                  "      return;",
                  "    }",
                  "    const json = res.json();",
                  "    if (!json.token) {",
                  "      console.error('Auto-signup missing token for redirect setup', json);",
                  "      return;",
                  "    }",
                  "    pm.environment.set('token', json.token);",
                  "    createLink(json.token);",
                  "  });",
                  "}",
                  "",
                  "const token = pm.environment.get('token') || pm.collectionVariables.get('token') || '';",
                  "if (token) {",
                  "  createLink(token);",
                  "} else {",
                  "  loginAndCreate();",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const slug = pm.environment.get('slug') || pm.collectionVariables.get('slug') || '';",
                  "pm.test('slug variable exists', function () {",
                  "  pm.expect(slug, 'slug missing: run Links/Create (Bearer) first or set slug in environment').to.not.equal('');",
                  "});",
                  "if (slug) {",
                  "  pm.test('Status is redirect', function () { pm.expect([301,302]).to.include(pm.response.code); });",
                  "  pm.test('Location header exists', function () { pm.expect(pm.response.headers.get('Location')).to.exist; });",
                  "}"
                ]
              }
            }
          ],
          "protocolProfileBehavior": {
            "followRedirects": false
          }
        },
        {
          "name": "Redirect Unknown Slug (404)",
          "description": "Unknown slug should return 404.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              }
            ],
            "url": "{{base_url}}/{{unknown_slug}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 404', function () { pm.response.to.have.status(404); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Health",
          "description": "App health endpoint.",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-Auth-Mode",
                "value": "none"
              }
            ],
            "url": "{{base_url}}/_internal/up"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status is 200', function () { pm.response.to.have.status(200); });"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000"
    },
    {
      "key": "name",
      "value": "Ana"
    },
    {
      "key": "email",
      "value": "ana@example.com"
    },
    {
      "key": "password",
      "value": "secret123"
    },
    {
      "key": "long_url",
      "value": "https://example.com/very/long/path"
    },
    {
      "key": "unknown_slug",
      "value": "zzzzz-not-found"
    },
    {
      "key": "AUTO_AUTH",
      "value": "true"
    }
  ]
}
